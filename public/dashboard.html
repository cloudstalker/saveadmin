<!DOCTYPE html>
<html>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<head>
		<title>Save Admin Tool</title>
		<link rel="stylesheet" type="text/css" href="style.css">
		<link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet"> 
		<meta name="theme-color" content="#63ab5b" />
	</head>
	<body onresize="checkSize()">
		<div id="pageContainer">
			<div id="navBar">
				<div class="whiteText" id="navBarTitle">Save Admin Tool</div>
				<div id="menuButtonAction">
					<img src="resources/icons/menu_icon.png" id="menuButtonImg" onclick="menuClicked()"/>
				</div>
				<ul>
					<li class="lists"><a href="settings.html" class="topLvl whiteText">Settings</a></li>
					<li class="lists dropdown">
						<a class="whiteText topLvl">Manage Accounts</a>
						<div class="dropdownContent">
							<a href="vendor.html">Vendor Accounts</a>
							<a>Admin Accounts</a>
						</div>
					</li>
					<li class="lists"><a href="dashboard.html" class="topLvl whiteText active">Dashboard</a></li>
				</ul>
			</div>
			<div id="statTitle" style="width:100%;">
				<img src="resources/icons/stat_icon.png"/>
				<p class="darkGrayText">Statistics</p>
				<button class="blueBg button whiteText" id="statButton" onclick="openGraphModal()">Custom Graph</button>
			</div>

			<div class="graphInstance">
				<div class="graphTitle">
					<p class="whiteText">Weekly Sign Up</p>
				</div>
				<div class="graph" id="firstGraph">

				</div>
			</div>
			<div class="modal">
				<div id="statModal">
					<h4 class="darkGrayText">Customize Your Graph</h4>
					<div class="graphOptions">
						<b>From:</b>&nbsp;
						<input type="date" name="from">&nbsp;
						<b>To:</b>&nbsp;
						<input type="date" name="to">
					</div>
					<div class="graphOptions">
						<b>Analyze:</b>&nbsp;
						<input type="checkbox" name="userBase" onchange="checkedAny()">
						User Base&nbsp;
						<input type="checkbox" name="generatedStickers" onchange="checkedAny()">
						Generated Stickers&nbsp;
						<input type="checkbox" name="redeemedStickers" onchange="checkedAny()">
						Redeemed Stickers
					</div>
					<div class="graphOptions hiddenOptions">
						<p style="margin-top: 0"><b>By:</b></p>
						<input type="checkbox" name="fc" onchange="fcChecked()">
						Foodcourts&nbsp;
						<select id="selectFc" disabled="true" onchange="fcSelected()">
							<option value="toSelect">All</option>
						</select>
					</div>
					<div class="graphOptions hiddenOptions">
						<input type="checkbox" name="vd" disabled="true" onchange="vdChecked()">
						Vendors&nbsp;
						<input type="checkbox" name="hide" disabled="true">
						Hide Foodcourt Plot&nbsp;
						<select id="selectVd" disabled="true" onchange="vdSelected()">
							<option value="toSelect">All</option>
						</select>
						<div>

						</div>
					</div>
					<div id="drawButton">
						<button class="button grayBg whiteText">Draw my graph</button>
					</div>
					<div class="graph" id="customGraph">
						Graph will appear here when you draw the graph
					</div>
				</div>
			</div>
		</div>
		<script src="https://www.gstatic.com/firebasejs/5.7.0/firebase-app.js"></script>
		<script src="https://www.gstatic.com/firebasejs/5.7.0/firebase-database.js"></script>
		<script src="https://www.gstatic.com/firebasejs/5.7.0/firebase-auth.js"></script>
		<script src="common_backend.js"></script>
		<script>
			// Global counters
			var firstEntry = true; // whether displaying first entry

			// Initialize Firebase
			var config = {
				apiKey: "AIzaSyD_8xDR6m1kA5Xg3YDmbbEsKdxM8HpP-44",
				authDomain: "nussave-app.firebaseapp.com",
				databaseURL: "https://nussave-app.firebaseio.com",
				projectId: "nussave-app",
				storageBucket: "nussave-app.appspot.com",
				messagingSenderId: "770570652465"
			};
			firebase.initializeApp(config);
		</script>
	</body>
	
	<script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.3.1.min.js"></script>
	<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
	<script src="jQueryRotate.js"></script>
	<script src="common_layout.js"></script>
	<script src="common_backend.js"></script>
	<script>
		firebase.auth().onAuthStateChanged(function(user) {
			if(!user){
				alert("Sign in first!");
				window.location.href = "index.html";
			}
		});

		var stuDbRef = firebase.database().ref('/User/Student');
		var fcDbRef = firebase.database().ref('/FoodCourt');
		var inputs = document.getElementsByTagName('input');
		var advancedOptions = {
			foodcourts: [],
			vendors: [],
			showFc: null
		}

		// Update foodcourts in custom graph options
		fcDbRef.once('value').then((snapshot)=>{
			var foodcourts = snapshot.val();
			var selectFc = document.getElementById("selectFc");
			for(var foodcourt in foodcourts){
				var selectOption = document.createElement('option');
				selectOption.value = foodcourt;
				selectOption.innerHTML = foodcourts[foodcourt]['name'];
				selectFc.appendChild(selectOption);
			}
		})

		// Add a foodcourt into the dataset. Does not include "All".
		function fcSelected(){
			var fcSelect = document.getElementById("selectFc");
			var fcSelected = fcSelect.children[fcSelect.selectedIndex];
			if(fcSelected.value != "toSelect"){
				var tag = document.createElement("button");
				tag.classList.add("tag");
				tag.classList.add("whiteText");
				tag.classList.add("purpleBg");
				tag.name = fcSelect.value;
				tag.innerHTML = fcSelected.innerHTML;
				fcSelect.parentElement.appendChild(tag);
				advancedOptions["foodcourts"].push(fcSelected.value);
				tag.onclick = tagClicked;
			}
			else{
				var fcSelectParent = fcSelect.parentElement;
				var tags = fcSelectParent.getElementsByTagName("button");
				for(var tag in tags){
					fcSelectParent.removeChild(tags[tag]);
				}
				advancedOptions["foodcourts"] = [];
			}
		}

		// Add a vendor into the dataset
		function vdSelected(){

		}

		// Remove tag and corresponding entry in advancedOptions
		function tagClicked(e){
			if(e.target.classList.contains("purpleBg")){
				var ind = advancedOptions["foodcourts"].indexOf(e.target.name);
				if(ind !== -1) advancedOptions["foodcourts"].splice(ind, 1);
			}
			else{
				if(e.target.classList.contains("darkBlueBg")){
					var ind = advancedOptions["vendors"].indexOf(e.target.name);
					if(ind !== -1) advancedOptions["vendors"].splice(ind, 1);
				}
			}
			var tagParent = e.target.parentElement;
			tagParent.removeChild(e.target);
			if(tagParent.getElementsByTagName("button").length === 0){
				document.getElementById("selectFc").selectedIndex = 0;
			}
		}

		stuDbRef.once('value').then((snapshot)=>{
			var students = snapshot.val();
			var currentDay = new Date();
			var currentWeek = getWeek(currentDay);
			var signUpData = {};
			for(var i=0; i<7; i++){
				var calcDay = new Date(currentWeek[0].getTime() + 60*60*24*1000*i);
				signUpData[yyyymmdd(calcDay)] = 0;
			}
			for(var student in students){
				var dateOfSignUp = students[student]['signUpDate'];
				var jsDateOfSignUp = new Date(dateOfSignUp);
				if(jsDateOfSignUp >= currentWeek[0] && jsDateOfSignUp <= currentWeek[1]){
					signUpData[yyyymmdd(jsDateOfSignUp)] += 1;
				}
			}
			// Drawing graphs
			var graph1 = document.getElementById('firstGraph');
			var dates = [];
			var counts = [];
			for(var dataPoint in signUpData){
				dates.push(dataPoint);
				counts.push(signUpData[dataPoint]);
			}
			var trace = {}
			trace['x'] = dates;
			trace['y'] = counts;
			trace['mode'] = 'lines';
			Plotly.plot(graph1, [trace], 
			{xaxis: {type: 'date', title: "Date"}, yaxis: {title: "User Sign-ups"},
				margin: { t: 0 } } );
		})

		// Button functions
		var modal = document.getElementsByClassName("modal")[0];
		function openGraphModal(){
			modal.style.display = "block";
		}

		window.onclick = function(event){
			if (event.target == modal) {
				modal.style.display = "none";
			}
		}

		// Visual change when there is at least one selected checkbox. Event fires when a checkbox changed state. 
		// Different from vendor.html
		function checkedAny(){
			var atLeastOneChecked = false;
			var advancedOptionChecked = false;
			for(var input in inputs){
				if(inputs[input].type == 'checkbox'){
					atLeastOneChecked = atLeastOneChecked || inputs[input].checked;
					if(inputs[input].name == "generatedStickers" || inputs[input].name == "redeemedStickers"){
						advancedOptionChecked = advancedOptionChecked || inputs[input].checked;
					}
				}
			}

			// Button color change
			var drButton = document.getElementById("drawButton").children[0];
			if(atLeastOneChecked){
				drButton.classList.remove('grayBg');
				drButton.classList.add('blueBg');
				drButton.onclick = drawGraph;
			}
			else{
				drButton.classList.remove('blueBg');
				drButton.classList.add('grayBg');
				drButton.onclick = null;
			}

			// Show advanced options
			var advOptions = document.getElementsByClassName("hiddenOptions");
			if(advancedOptionChecked){
				advOptions[0].style.display = "block";
				advOptions[1].style.display = "block";
			}
			else{
				advOptions[0].style.display = "none";
				advOptions[1].style.display = "none";
			}
		}

		// Enable secondary options
		function fcChecked(){
			var selects = document.getElementsByTagName("select");
			if(inputs[5].checked){
				inputs[6].disabled = false;
				selects[0].disabled = false;
			}
			else{
				inputs[6].disabled = true;
				selects[0].disabled = true;
			}
		}

		function vdChecked(){
			var selects = document.getElementsByTagName("select");
			if(inputs[6].checked){
				inputs[7].disabled = false;
				selects[1].disabled = false;
			}
			else{
				inputs[7].disabled = true;
				selects[1].disabled = true;
			}
		}

		// Draw the graphs according to specified options
		function drawGraph(){
			var fromDate = new Date(inputs[0]);
			var toDate = new Date(inputs[1]);
			var userChkBox = inputs[2];
			var gsChkBox = inputs[3];
			var rsChkBox = inputs[4];
			var rsSelect = document.getElementById("selectFc");
			
			// Initial checks
			if(rsChkBox.checked){
				if(rsSelect.selectedIndex == 0){
					alert("Select a foodcourt to analyze redeemed stickers");
					return;
				}
			}
			if(fromDate < toDate){

			}
			else{
				alert("From Date must be smaller!");
				return;
			}

			// Preparing data
			var data = [];
			var trace = new Object();
			trace['x'] = [];
			trace['y'] = [];
			trace['mode'] = 'lines';
			var interDate = fromDate;
			while(interDate <= toDate){
				trace['x'].push(yyyymmdd(interDate));
				interDate = new Date(interDate.getTime() + 60*60*24*1000);
			}
			var trace2 = trace;
			var trace3 = trace;

			// Pushing user base statistics according to date duration
			if(userChkBox.checked){
				stuDbRef.once('value').then((snapshot)=>{
					var students = snapshot.val();
					for(var i = 0; i< trace['x'].length; i++){
						trace['y'].push(0);
					}
					for(var student in students){
						var dateOfSignUp = students[student]['signUpDate'];
						var jsDateOfSignUp = new Date(dateOfSignUp);
						if(jsDateOfSignUp >= fromDate && jsDateOfSignUp <= toDate){
							trace['y'][trace['x'].indexOf(yyyymmdd(jsDateOfSignUp))] += 1;
						}
					}
					trace['name'] = "User Base";
					data.push(trace);
				})
			}
			
			// Pushing generated & redeemed statistics data according to date duration
			if(gsChkBox.checked || rsChkBox.checked){
				var fcChkBox = inputs[5];
				var vdChkBox = inputs[6];
				var hideChkBox = inputs[7];
				firebase.database().ref("/Sticker").once('value').then((ssnapshot)=>{
					if(fcChkBox.checked){
						if(vdChkBox.checked){
							if(hideChkBox.checked){ // Showing specified foodcourts, specified vendors, hiding foodcourts

							}
							else{ // Showing specified foodcourts, specified vendors, not hiding foodcourts

							}
						}
						else{ // Showing specified foodcourts, no vendors

						}
					}
					else{ // Showing all foodcourts plus total amount

					}
				})
				
			}
		}
	</script>
</html>