<!DOCTYPE html>
<html>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<head>
		<title>Save Admin Tool</title>
		<link rel="stylesheet" type="text/css" href="style.css">
		<link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet"> 
		<meta name="theme-color" content="#63ab5b" />
	</head>
	<body onresize="checkSize()">
		<div id="pageContainer">
			<div id="navBar">
				<div class="whiteText" id="navBarTitle">Save Admin Tool</div>
				<div id="menuButtonAction">
					<img src="resources/icons/menu_icon.png" id="menuButtonImg" onclick="menuClicked()"/>
				</div>
				<ul>
					<li class="lists"><a href="settings.html" class="topLvl whiteText">Settings</a></li>
					<li class="lists dropdown">
						<a class="whiteText topLvl">Manage Accounts</a>
						<div class="dropdownContent">
							<a href="vendor.html">Vendor Accounts</a>
							<a>Admin Accounts</a>
						</div>
					</li>
					<li class="lists"><a href="dashboard.html" class="topLvl whiteText active">Dashboard</a></li>
				</ul>
			</div>
			<div id="statTitle">
				<img src="resources/icons/stat_icon.png"/>
				<p class="darkGrayText">Statistics</p>
			</div>

			<div class="graphInstance">
				<div class="graphTitle">
					<p class="whiteText">Weekly Sign Up</p>
				</div>
				<div class="graph" id="firstGraph">

				</div>
			</div>
		</div>
		<script src="https://www.gstatic.com/firebasejs/5.7.0/firebase-app.js"></script>
		<script src="https://www.gstatic.com/firebasejs/5.7.0/firebase-database.js"></script>
		<script src="https://www.gstatic.com/firebasejs/5.7.0/firebase-auth.js"></script>
		<script src="common_backend.js"></script>
		<script>
			// Global counters
			var firstEntry = true; // whether displaying first entry

			// Initialize Firebase
			var config = {
				apiKey: "AIzaSyD_8xDR6m1kA5Xg3YDmbbEsKdxM8HpP-44",
				authDomain: "nussave-app.firebaseapp.com",
				databaseURL: "https://nussave-app.firebaseio.com",
				projectId: "nussave-app",
				storageBucket: "nussave-app.appspot.com",
				messagingSenderId: "770570652465"
			};
			firebase.initializeApp(config);
		</script>
	</body>
	
	<script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.3.1.min.js"></script>
	<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
	<script src="jQueryRotate.js"></script>
	<script src="common_layout.js"></script>
	<script src="common_backend.js"></script>
	<script>
		firebase.auth().onAuthStateChanged(function(user) {
			if(!user){
				alert("Sign in first!");
				window.location.href = "index.html";
			}
		});

		var stuDbRef = firebase.database().ref('/User/Student');

		stuDbRef.once('value').then((snapshot)=>{
			var students = snapshot.val();
			var currentDay = new Date();
			var currentWeek = getWeek(currentDay);
			var signUpData = {};
			for(var i=0; i<7; i++){
				var calcDay = new Date(currentWeek[0].getTime() + 60*60*24*1000*i);
				signUpData[yyyymmdd(calcDay)] = 0;
			}
			for(var student in students){
				var dateOfSignUp = students[student]['signUpDate'];
				var jsDateOfSignUp = new Date(dateOfSignUp);
				if(jsDateOfSignUp >= currentWeek[0] && jsDateOfSignUp <= currentWeek[1]){
					signUpData[yyyymmdd(jsDateOfSignUp)] += 1;
				}
			}
			// Drawing graphs
			var graph1 = document.getElementById('firstGraph');
			var dates = [];
			var counts = [];
			for(var dataPoint in signUpData){
				dates.push(dataPoint);
				counts.push(signUpData[dataPoint]);
			}
			var trace = {}
			trace['x'] = dates;
			trace['y'] = counts;
			trace['mode'] = 'lines';
			console.log(trace);
			Plotly.plot(graph1, [trace], 
			{xaxis: {type: 'date', title: "Date"}, yaxis: {title: "User Sign-ups"},
				margin: { t: 0 } } );
		})
	</script>
</html>