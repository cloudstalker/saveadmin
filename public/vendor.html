<!DOCTYPE html>
<html>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<head>
		<title>Save Admin Tool</title>
		<link rel="stylesheet" type="text/css" href="style.css">
		<link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet"> 
	</head>
	<body onresize="checkSize()">
		<div id="pageContainer">
			<div id="navBar">
				<div class="whiteText" id="navBarTitle">Save Admin Tool</div>
				<div id="menuButtonAction">
					<img src="resources/icons/menu_icon.png" id="menuButtonImg" onclick="menuClicked()"/>
				</div>
				<ul>
					<li class="lists"><a href="settings.html" class="topLvl whiteText">Settings</a></li>
					<li class="lists dropdown">
						<a class="whiteText topLvl active">Manage Accounts</a>
						<div class="dropdownContent">
							<a href="vendor.html">Vendor Accounts</a>
							<a>User Accounts</a>
							<a>Admin Accounts</a>
						</div>
					</li>
					<li class="lists"><a href="index.html" class="topLvl whiteText">Dashboard</a></li>
				</ul>
			</div>
			<div id="vendorTitle">
				<div style="display: inline-block; width: 100%">
					<p class="lightGrayText vendorHeader">Vendor Accounts</p>
					<button class="vendorButton greenBg button" onclick="uploadVendorData()">
						<img src="resources/icons/duload_icon.png" style="transform: rotate(180deg)"/>
						<p class="whiteText">Upload</p>
					</button>
					<button class="vendorButton greenBg button" onclick="downloadVendorData()">
						<img src="resources/icons/duload_icon.png"/>
						<p class="whiteText">Download</p>
					</button>
					<button class="vendorButton blueBg button" onclick="openSettleModal()">
						<img src="resources/icons/settle_icon.png"/>
						<p class="whiteText">Settle</p>
					</button>
				</div>
				<div style="overflow: auto">
					<table id="recordTable">
						<thead>
							<tr id="vendorProperties">

							</tr>
						</tbody>
						<tbody id="vendorRecords">
							
						</tbody>
					</table>
				</div>
				<div id="vendorRecordBg">

				</div>
			</div>
		</div>
		<div class="modal">
			<div id="settleModal">
				<h4 class="darkGrayText">Preparing for Reimbursement</h4>
			</div>
		</div>
	</body>
	
	<script src="https://www.gstatic.com/firebasejs/5.7.0/firebase.js"></script>	
	<script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.3.1.min.js"></script>
	<script src="jQueryRotate.js"></script>
	<script src="common_layout.js"></script>
	<script>
		// Global counters
		var firstEntry = true; // whether displaying first entry

		// Initialize Firebase
		var config = {
			apiKey: "AIzaSyD_8xDR6m1kA5Xg3YDmbbEsKdxM8HpP-44",
			authDomain: "nussave-app.firebaseapp.com",
			databaseURL: "https://nussave-app.firebaseio.com",
			projectId: "nussave-app",
			storageBucket: "nussave-app.appspot.com",
			messagingSenderId: "770570652465"
		};
		firebase.initializeApp(config);

		// Creating column titles
		const columnNumber = 8;
		var divWidth = 100.0 / (columnNumber + 1);
		var columns = ["VendorID", "Name", "FoodcourtID", "Type", "Unsettled", "TotalRedeem", "Contact", "Password"];
		for (var i = 0; i < columnNumber; i++){
			var th = document.createElement("TD");
			var t = document.createTextNode(columns[i]);
			th.appendChild(t);
			th.style.textAlign = "right";
			th.style.fontSize = "75%";
			th.style.fontWeight = "600";
			th.className = "darkGrayText";
			document.getElementById("vendorProperties").appendChild(th);
		}

		// Grabbing data & show 
		var vendorDbRef = firebase.database().ref('/Vendor/');
		vendorDbRef.on('value', function(snapshot){
			var vendors = snapshot.val();

			// reset
			var vendorRecords = document.getElementById("vendorRecords");
			var vendorRecordBg = document.getElementById("vendorRecordBg");
			while(vendorRecords.lastChild){
				vendorRecords.removeChild(vendorRecords.lastChild);
			}
			while(vendorRecordBg.lastChild){
				vendorRecordBg.removeChild(vendorRecordBg.lastChild);
			}
			firstEntry = true;

			for(var element in vendors){
				var division = document.createElement("DIV");
				var tr = document.createElement("TR");
				for (var i = 0; i < columnNumber; i++){
					var td = document.createElement("TD");
					var t = document.createTextNode(vendors[element][columns[i]]);
					td.appendChild(t);
					td.style.textAlign = "right";
					td.style.fontSize = "75%";
					tr.appendChild(td);
				}
				if(firstEntry){
					division.className = "vendorRecordFill";
					firstEntry = false;
				}
				else{
					division.className = "vendorRecordFillMore";
				}
				vendorRecordBg.appendChild(division);
				vendorRecords.appendChild(tr);
			}
		})

		// Button Functions
		var modal = document.getElementsByClassName("modal")[0];
		function openSettleModal(){
			modal.style.display = "block";
		}

		window.onclick = function(event){
			if (event.target == modal) {
					modal.style.display = "none";
			}
		}

		function downloadVendorData(){
			vendorDbRef.once('value').then(function(snapshot){
				var content = new Array();
				content.push(columns.toString() + "\n");
				var vendors = snapshot.val();
				for(var element in vendors){
					var tempStr = "";
					for (var i = 0; i < columnNumber - 1; i++){
						tempStr = tempStr + (vendors[element][columns[i]] + ",");
					}
					tempStr += (vendors[element][columns[columnNumber-1]] + "\n");
					content.push(tempStr);
				}
				var blob = new Blob(content, {type: 'text/csv'});
				if(window.navigator.msSaveOrOpenBlob) {
					window.navigator.msSaveBlob(blob, "vendorData.csv");
				}
				else{
					var elem = window.document.createElement('A');
					elem.href = window.URL.createObjectURL(blob);
					elem.download = "vendorData.csv";        
					document.body.appendChild(elem);
					elem.click();        
					document.body.removeChild(elem);
			}	
			});
		}

		function uploadVendorData(){
			var fileInput = document.createElement("INPUT");
			fileInput.type = "file";
			fileInput.accept = ".csv, text/csv";
			fileInput.style.opacity = 0;
			fileInput.id = "hiddenInputForFileUpload";
			fileInput.addEventListener('change', uploadedEventHandler, false);
			document.body.appendChild(fileInput);
			fileInput.click();
		}

		function uploadedEventHandler() {
			const file = this.files[0];
			var fileReader = new FileReader();
			fileReader.onload = function(e){
				data = e.target.result.split("\n");
				for(var j = 1; j < data.length; j++){
					// row not empty then...
					if(data[j] != ""){
						var tempObj = new Object();
						var tempArr = data[j].split(",");
						for(var i = 0; i < columnNumber; i++){
							tempObj[columns[i]] = tempArr[i];
						}
						tempObj["Password"] == "" ? tempObj["Password"] = Math.round(100000000 * Math.random()): null;
						var update = new Object();
						update[tempObj["VendorID"]] = tempObj;
						vendorDbRef.update(update);
					}
				}
			}
			fileReader.readAsText(file);
		}

		// Table scrolling
		var inner = document.getElementById("recordTable");
		inner.addEventListener('scroll', function(e) {
			e.stopPropagation();
			}, false);

		inner.addEventListener('wheel', function(e) {
			if(e.wheelDelta < 0) {
			if((this.scrollHeight-this.scrollTop-200)<=0){
				e.preventDefault();
			}
				}
				else
				if(this.scrollTop==0){
				e.preventDefault();
				}
			}, false);

		inner.addEventListener('touchmove', function(e) {
			e.stopPropagation();
			}, false);
	</script>
</html>